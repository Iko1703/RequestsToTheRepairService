## Архитектурные решения и стек

Дата решения: 19.02.2026

### 1. Общая цель

Реализовать небольшое веб-приложение для приёма и обработки заявок в ремонтную службу с ролями **диспетчер** и **мастер**, учётом гонок запросов при "взятии" заявки и возможностью локального запуска как **с Docker**, так и **без него**.

---

### 2. Стек технологий

- **Язык**: Java 17+
- **Backend-фреймворк**: Spring Boot
- **Web-слой**: Spring MVC (REST-контроллеры + простые HTML-страницы)
- **База данных**: PostgreSQL
- **ORM**: JPA / Hibernate
- **Безопасность и авторизация**: Spring Security (форма логина, роли `DISPATCHER` и `MASTER`)
- **Сборка**: Maven или Gradle (будет зафиксировано при инициализации проекта)
- **Миграции БД (опционально)**: Flyway или Liquibase (если по времени успеем; иначе — SQL-скрипт инициализации)
- **Докеризация**: Dockerfile + Docker Compose (приложение + PostgreSQL)
- **Тестирование**: 
  - JUnit 5
  - Spring Boot Test для интеграционных тестов

---

### 3. Доменная модель и ключевые сущности

- **Ticket (Заявка)**:
  - `clientName` (обязательно)
  - `phone` (обязательно)
  - `address` (обязательно)
  - `problemText` (обязательно)
  - `status`: `new | assigned | in_progress | done | canceled`
  - `assignedTo` (мастер, может быть пустым)
  - `createdAt`, `updatedAt`
  - `version` — для борьбы с гонками (optimistic locking)

- **User (Пользователь системы)**:
  - `username`
  - `passwordHash`
  - `role`: `DISPATCHER` или `MASTER`

- **TicketAudit / TicketEvent (История действий по заявке, опционально, но планируем реализовать)**:
  - привязка к заявке
  - кто, когда и какое действие совершил
  - краткие детали изменения (например, смена статуса, назначение мастера)

---

### 4. Роли и права доступа

- **Диспетчер (DISPATCHER)**:
  - создавать заявки;
  - видеть все заявки;
  - назначать мастера на заявку;
  - отменять заявки.

- **Мастер (MASTER)**:
  - видеть только релевантные ему заявки (своё подмножество и/или доступные к взятию);
  - "брать" заявку в работу (операция `take`, критичная к гонкам);
  - переводить свои заявки в статусы `in_progress`, `done`;
  - при необходимости — отменять свои заявки (если это будет разрешено правилами, зафиксируем в коде/README).

Ограничения и проверки прав доступа будут реализованы на двух уровнях:

1. **Spring Security** — ограничение доступа к URL/эндпоинтам по ролям.
2. **Бизнес-логика в сервисах** — проверка допустимости операций (смена статуса, владение заявкой и т.д.).

---

### 5. Обработка гонок запросов (race conditions)

Критичный сценарий — параллельное выполнение операции **take** (несколько мастеров одновременно пытаются взять одну и ту же заявку).

- Выбранный подход: **optimistic locking** на уровне JPA/Hibernate.
  - В сущности `Ticket` используется поле `@Version`.
  - При попытке "взять" заявку:
    - считывается актуальное состояние заявки;
    - проверяется статус и отсутствие уже назначенного/взявшего мастера;
    - выполняется обновление `assignedTo` и `status` в одной транзакции;
    - при конфликте версий Hibernate выбрасывает `OptimisticLockException`.
  - Конфликт обрабатывается и конвертируется в HTTP-ответ **409 Conflict** с понятным сообщением для пользователя (например: "Заявка уже взята другим мастером").

- Дополнительно в документации/README будет кратко описан альтернативный подход с **pessimistic locking** (`SELECT FOR UPDATE`), но основная реализация — через optimistic locking.

- Для демонстрации корректной обработки гонок будет добавлен скрипт **`race_test.sh`** (и по возможности PowerShell-скрипт), который параллельно вызывает операцию `take` и показывает, что успешно проходит только один запрос.

---

### 6. Архитектура приложения

Приложение будет разделено на несколько слоёв:

- **`controller`**:
  - REST-контроллеры для работы с заявками (создание, просмотр, смена статуса, операции диспетчера и мастера);
  - обработка форм входа/выхода (login/logout).

- **`service`**:
  - бизнес-логика по управлению заявками и переходами статусов;
  - проверка прав и инвариантов доменной модели;
  - взаимодействие с аудитом.

- **`repository`**:
  - JPA-репозитории для `Ticket`, `User`, `TicketAudit`.

- **`domain/model`**:
  - сущности JPA и доменные enum'ы (например, статус заявки, тип события аудита).

- **`security`**:
  - конфигурация Spring Security (форм-логин, настройка ролей, защита URL).

- **`dto`**:
  - классы запросов/ответов для REST и форм, отделённые от сущностей БД.

Такое разделение подчёркивает слоистую архитектуру и облегчает тестирование.

---

### 7. UI и пользовательский опыт

- **Подход**: простые HTML-страницы и формы на базе Spring MVC (Thymeleaf или аналогичный шаблонизатор), плюс REST-эндпоинты для операций.
- **Страницы**:
  - страница создания заявки;
  - панель диспетчера (список заявок, фильтры, назначение мастеров, отмена);
  - панель мастера (список доступных и своих заявок, операции `take`, `start`, `done`).
- **Обработка ошибок**:
  - на бекенде — глобальный обработчик ошибок (ControllerAdvice) с понятными сообщениями и правильными HTTP-статусами (400, 403, 404, 409 и т.п.);
  - на фронтенде — человекочитаемые сообщения об ошибках/успехах при отправке форм.

---

### 8. Тестирование

- **Unit-тесты**:
  - ключевая бизнес-логика в `TicketService` (переходы статусов, проверки прав).

- **Интеграционные тесты** (Spring Boot Test):
  - сценарий полного жизненного цикла заявки (создание → назначение/взятие → работа → завершение);
  - тесты на гонки (несколько параллельных попыток `take`).

По возможности будет использован либо in-memory H2, либо Testcontainers с PostgreSQL для большей реалистичности.

---

### 9. Запуск и окружения

- **Локальный запуск без Docker**:
  - установка JDK и PostgreSQL;
  - настройка параметров подключения к БД через `application.properties` или профиль `local`;
  - запуск через Maven/Gradle либо готовый JAR.

- **Запуск с Docker Compose**:
  - `docker-compose.yml` поднимает:
    - контейнер с PostgreSQL;
    - контейнер с приложением (Spring Boot).
  - отдельный профиль конфигурации (`application-docker.properties`) для подключения к БД в Docker-сети.

Развёртывание на VPS не является обязательным, но архитектура и докеризация позволяют сделать это без существенных изменений.

---

### 10. Документация и дополнительные плюсы

- Файл `README.md`:
  - инструкции по запуску (с Docker и без);
  - список тестовых пользователей и ролей;
  - примеры curl/HTTP-запросов;
  - краткое описание реализации борьбы с гонками.

- История действий по заявке (audit log) планируется к реализации и будет видна на странице заявки.

Эти решения приняты с прицелом на читаемость кода, демонстрацию хороших практик (слои, сервисы, транзакции, аудит, обработка ошибок) и лёгкую проверку задания ревьюером.



